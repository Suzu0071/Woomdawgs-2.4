
#what to set in the slicer:
#_PRINT_START EXTRUDER=[nozzle_temperature_initial_layer] BED=[bed_temperature_initial_layer_single] MATERIAL=[filament_type[initial_extruder]]
[gcode_macro _PRINT_START]
gcode:
  {% set BED = params.BED|default(60)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(200)|float %}
  {% set MATERIAL = params.MATERIAL %}
  #_SET_MPC_MATERIAL MATERIAL={MATERIAL}
  #this is if youre using kalico and mpc on your hotend

  SKIRT_FAN SPEED=0.5 #Skirt fan set speed

  M140 S{70} #set bed
  M104 S{170} #set extruder
  NEVERMORE MATERIAL={MATERIAL}
  G90 #absolute coordinate
  G32
  BED_MESH_CALIBRATE PROBE_SPEED=200 #PROBE_SPEED changes how fast it'll do the mesh
  BED_MESH_PROFILE LOAD=default
  G0 X0 Y0 Z5 #move up a bit
  M190 S{BED}
  M109 S{EXTRUDER}
  _CURA_PURGE_LINE #purge line goes here
  G92 E0 #zero the extruder

[gcode_macro _PRINT_END]
gcode:
    {% set safe_z = 20 %} #change this to the distance the z will go up by

    {% set z_max = printer.toolhead.axis.maximum_z %}
    {% set z_pos = printer.toolhead.position.z %}

    {% set y_max = printer.toolhead.axis.maximum_y %}

    {% if z_pos+safe_z > z_max %}
        {% set move_z = z_max-z_pos %}
    {% else %}
        {% set move_z = safe_z %}
    {% endif %}

    TURN_OFF_HEATERS #turn off heaters and fan
    M106 S0

    G91 #retract 3mm and move z to the safe z distance
    G1 E-3 F1500
    G1 Z{safe_z} F800
    G90
    G1 Y{y_max} F3000 #move y to the back and x to the left
    G1 X0 F3000

    SKIRT_FAN SPEED=0

#nevermore macro
[gcode_macro NEVERMORE]
#syntax is `NEVERMORE MATERIAL=nyaa`
variable_nevermore_speed: 0.5 #speed that the fans will run on
variable_filament_table:
    {
    #if you need another material, add it here without a comment
        #"PLA",
        #"PETG",
        "PC+ABS",
        "ABS",
        "ASA",
        "PA6",
        "PA",
        "PC", 
        #"TPU",
        #"TPU-90A",
        #"TPU-95A",
        "ABS-CF" ,
        "ASA-CF",
        "PA6-CF",
        "PC+ABS-CF",
        "PC+CF",
        #"PLA-CF",
        #"PETG-CF",
    }
gcode:
  {% set MATERIAL = params.MATERIAL %}

  {% if MATERIAL in filament_table %}
    RESPOND MSG="Material is {MATERIAL}, Nevermore turned on."
    SET_FAN_SPEED FAN=nevermore_1 SPEED={nevermore_speed}
    SET_FAN_SPEED FAN=nevermore_2 SPEED={nevermore_speed} #delete this line if using nevermore with one fan
  {% elif %}
    RESPOND MSG="{MATERIAL} not in table, Nevermore is off."
  {% endif %}

[gcode_macro SKIRT_FAN]
#syntax is `SKIRT_FAN SPEED=nyaa`
gcode:
  {% set SPEED = params.SPEED | float %}
  
  SET_FAN_SPEED FAN=SkirtFan_1 SPEED={SPEED}
  SET_FAN_SPEED FAN=SkirtFan_2 SPEED={SPEED}
  #SET_FAN_SPEED FAN=SkirtFan_3 SPEED={SPEED}

[gcode_macro G32]
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28
    G0 X175 Y175 Z30 F3600
    RESTORE_GCODE_STATE NAME=STATE_G32

#I included my purge but you can change it c:
[gcode_macro _CURA_PURGE_LINE]
gcode:
  {% set y_max = printer.toolhead.axis_maximum.y %}

  G1 Z2.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed
  G1 X0.1 Y20 Z0.3 F5000.0 ; Move to start position
  G1 X0.1 Y{y_max-20} Z0.3 F1500.0 E{(y_max-20)/12} ; Draw the first line
  G1 X0.4 Y{y_max-20} Z0.3 F5000.0 ; Move to side a little
  G1 X0.4 Y20 Z0.3 F1500.0 E{(y_max-20)/6} ; Draw the second line
  G92 E0 ; Reset Extruder
  G1 Z2.0 F3000 ; Move Z Axis up little to prevent scratching of Heat Bed
  G1 X5 Y20 Z0.3 F5000.0 ; Move over to prevent blob squish

############################################################################
#All the SB logo led stuff

[gcode_macro _LOGO_PENDING]
gcode:
  SET_LED LED=rgb_light RED=0.15 GREEN=0.5 BLUE=0.75 WHITE=0 INDEX=1

[gcode_macro _LOGO_READY]
gcode:
  SET_LED LED=rgb_light RED=0.99 GREEN=0.0 BLUE=0.0 WHITE=0 INDEX=1

[gcode_macro _LOGO_OFF]
gcode:
  SET_LED LED=rgb_light RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=1
  

[gcode_macro _HEADLIGHT_ON]
gcode:
  SET_LED LED=rgb_light RED=1 GREEN=1 BLUE=1 WHITE=1.0 INDEX=2 TRANSMIT=0
  SET_LED LED=rgb_light RED=1 GREEN=1 BLUE=1 WHITE=1.0 INDEX=3


[gcode_macro _HEADLIGHT_OFF]
gcode:
  SET_LED LED=rgb_light RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=2 TRANSMIT=0
  SET_LED LED=rgb_light RED=0 GREEN=0 BLUE=0 WHITE=0 INDEX=3